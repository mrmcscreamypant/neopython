var gdjs;(function(p){let D;(function(P){const u=class{constructor(t,e){this._transformation=new p.AffineTransformation;this._inverseTransformation=new p.AffineTransformation;this._transformationUpToDateCount=1;this._source=t,this.tag=e,this._layers=new Map,this._buildLayersFromTileMap(t,this._layers)}updateFromTileMap(t){this._source=t,this._layers=new Map,this._buildLayersFromTileMap(t,this._layers)}_buildLayersFromTileMap(t,e){for(const n of t.getLayers()){if(!(n instanceof TileMapHelper.EditableTileMapLayer))continue;const i=n;e.set(i.id,new v(this,i))}}getTransformation(){return this._transformation}setTransformation(t){this._transformation=t;const e=this._inverseTransformation;e.copyFrom(t),e.invert(),this._invalidate()}_invalidate(){this._transformationUpToDateCount=(this._transformationUpToDateCount+1)%Number.MAX_SAFE_INTEGER}invalidateTile(t,e,n){const i=this.getLayer(t);if(i){const s=i.get(e,n);s&&s.invalidate()}}getWidth(){return this._source.getWidth()}getHeight(){return this._source.getHeight()}getTileHeight(){return this._source.getTileHeight()}getTileWidth(){return this._source.getTileWidth()}getDimensionX(){return this._source.getDimensionX()}getDimensionY(){return this._source.getDimensionY()}getTileDefinition(t){return this._source.getTileDefinition(t)}getLayer(t){return this._layers.get(t)}getLayers(){return this._layers.values()}pointIsInsideTile(t,e,n){const i=u.workingPoint;return i[0]=t,i[1]=e,this._inverseTransformation.transform(i,i),this._source.pointIsInsideTile(i[0],i[1],n)}getHitboxesAround(t,e,n,i,s){const o=this._inverseTransformation,r=u.workingPoint;r[0]=e,r[1]=n,o.transform(r,r);const h=r[0],a=r[1];r[0]=i,r[1]=n,o.transform(r,r);const y=r[0],f=r[1];r[0]=i,r[1]=s,o.transform(r,r);const g=r[0],l=r[1];r[0]=e,r[1]=s,o.transform(r,r);const c=r[0],T=r[1],B=Math.max(0,Math.floor(Math.min(h,y,g,c)/this._source.getTileWidth())),I=Math.min(this.getDimensionX()-1,Math.floor(Math.max(h,y,g,c)/this._source.getTileWidth())),F=Math.max(0,Math.floor(Math.min(a,f,l,T)/this._source.getTileHeight())),L=Math.min(this.getDimensionY()-1,Math.floor(Math.max(a,f,l,T)/this._source.getTileHeight()));return this.getHitboxes(t,B,F,I,L)}getHitboxes(t,e,n,i,s){return new d(this,t,e,n,i,s)}getAllHitboxes(t){return this.getHitboxes(t,0,0,this._source.getDimensionX()-1,this._source.getDimensionY()-1)}};let H=u;H.workingPoint=[0,0],P.TransformedCollisionTileMap=H;const _=class{constructor(t,e,n,i,s,o){this.map=t,this.tag=e,this.xMin=n,this.yMin=i,this.xMax=s,this.yMax=o}[Symbol.iterator](){let t=this.map.getLayers()[Symbol.iterator](),e=_.emptyItr;return{next:()=>{let n=e.next();for(;n.done;){const i=t.next();if(i.done)return n;e=i.value.getHitboxes(this.tag,this.xMin,this.yMin,this.xMax,this.yMax)[Symbol.iterator](),n=e.next()}return n}}}};let d=_;d.emptyItr={next:()=>({value:void 0,done:!0})};class v{constructor(t,e){this.tileMap=t,this._source=e,this._tiles=[];const n=this._source.getDimensionX(),i=this._source.getDimensionY();this._tiles.length=i;for(let s=0;s<i;s++){this._tiles[s]=[],this._tiles[s].length=n;for(let o=0;o<n;o++)this._tiles[s][o]=new M(this,o,s)}}get(t,e){const n=this._tiles[e];return n?n[t]:void 0}getDimensionX(){return this._tiles.length===0?0:this._tiles[0].length}getDimensionY(){return this._tiles.length}getWidth(){return this._source.getWidth()}getHeight(){return this._source.getHeight()}isFlippedDiagonally(t,e){return this._source.isFlippedDiagonally(t,e)}isFlippedVertically(t,e){return this._source.isFlippedVertically(t,e)}isFlippedHorizontally(t,e){return this._source.isFlippedHorizontally(t,e)}getHitboxes(t,e,n,i,s){return new m(this,t,e,n,i,s)}getAllHitboxes(t){return this.getHitboxes(t,0,0,this.getDimensionX()-1,this.getDimensionY()-1)}}P.TransformedCollisionTileMapLayer=v;const b=class{constructor(t,e,n,i,s,o){this.layer=t,this.tag=e,this.xMin=n,this.yMin=i,this.xMax=s,this.yMax=o}[Symbol.iterator](){let t=this.xMax,e=this.yMin-1,n=b.emptyItr;return{next:()=>{let i=n.next();for(;i.done;){if(t++,t>this.xMax&&(e++,t=this.xMin),e>this.yMax)return i;const s=this.layer.get(t,e);if(!s)continue;const o=s.getDefinition();!o||o.hasTaggedHitBox(this.tag)&&(n=s.getHitboxes()[Symbol.iterator](),i=n.next())}return i}}}};let m=b;m.emptyItr={next:()=>({value:void 0,done:!0})};const x=class{constructor(t,e,n){this.affineTransformationUpToDateCount=0;this.layer=t,this.x=e,this.y=n;const i=this.getDefinition();if(this.hitBoxes=[],i){const s=this.layer.tileMap.tag,o=i.getHitBoxes(s);if(o){this.hitBoxes.length=o.length;for(let r=0;r<this.hitBoxes.length;r++){const h=new p.Polygon;this.hitBoxes[r]=h,h.vertices.length=o[r].length;for(let a=0;a<h.vertices.length;a++)h.vertices[a]=[0,0]}}}}getDefinition(){return this.layer.tileMap.getTileDefinition(this.layer._source.getTileId(this.x,this.y))}_isHitboxesUpToDate(){return this.affineTransformationUpToDateCount===this.layer.tileMap._transformationUpToDateCount}_setHitboxesUpToDate(){this.affineTransformationUpToDateCount=this.layer.tileMap._transformationUpToDateCount}invalidate(){this.affineTransformationUpToDateCount=-1;let t=this.layer.get(this.x-1,this.y);t&&(t.affineTransformationUpToDateCount=-1),t=this.layer.get(this.x+1,this.y),t&&(t.affineTransformationUpToDateCount=-1),t=this.layer.get(this.x,this.y-1),t&&(t.affineTransformationUpToDateCount=-1),t=this.layer.get(this.x,this.y+1),t&&(t.affineTransformationUpToDateCount=-1)}getHitboxes(){if(this._isHitboxesUpToDate())return this.hitBoxes;const t=this.getDefinition();if(!t)return this._setHitboxesUpToDate(),this.hitBoxes.length=0,this.hitBoxes;const e=this.layer.tileMap.tag,n=t.getHitBoxes(e);if(!n)return this._setHitboxesUpToDate(),this.hitBoxes.length=0,this.hitBoxes;const i=this.layer.tileMap,s=i.getTileWidth(),o=i.getTileHeight();if(n.length===1&&t.hasFullHitBox(e)){const a=this._hasNeighborFullHitBox(-1,0),y=this._hasNeighborFullHitBox(1,0),f=this._hasNeighborFullHitBox(0,-1),g=this._hasNeighborFullHitBox(0,1);let l=0;if(a||y){let c=a?-s:0,T=y?2*s:s;l>=this.hitBoxes.length&&(this.hitBoxes[l]=p.Polygon.createRectangle(0,0)),x.setRectangle(this.hitBoxes[l],c,0,T,o),l++}if(f||g){let c=f?-o:0,T=g?2*o:o;l>=this.hitBoxes.length&&(this.hitBoxes[l]=p.Polygon.createRectangle(0,0)),x.setRectangle(this.hitBoxes[l],0,c,s,T),l++}l===0&&(this.hitBoxes.length===0&&(this.hitBoxes[0]=p.Polygon.createRectangle(0,0)),x.setRectangle(this.hitBoxes[0],0,0,s,o),l++),this.hitBoxes.length=l}else for(let a=0;a<n.length;a++){const y=n[a];a>=this.hitBoxes.length&&(this.hitBoxes[a]=p.Polygon.createRectangle(0,0));const f=this.hitBoxes[a];for(let g=0;g<f.vertices.length;g++){const l=y[g],c=f.vertices[g];c[0]=l[0],c[1]=l[1]}}const h=x.workingTransformation;h.setToTranslation(s*this.x,o*this.y),this.layer.isFlippedHorizontally(this.x,this.y)&&h.flipX(s/2),this.layer.isFlippedVertically(this.x,this.y)&&h.flipY(o/2),this.layer.isFlippedDiagonally(this.x,this.y)&&(h.flipX(s/2),h.rotateAround(Math.PI/2,s/2,o/2)),h.preConcatenate(i.getTransformation());for(let a=0;a<this.hitBoxes.length;a++){const y=this.hitBoxes[a];for(let f=0;f<y.vertices.length;f++){const g=y.vertices[f];h.transform(g,g)}}return this._setHitboxesUpToDate(),this.hitBoxes}_hasNeighborFullHitBox(t,e){const i=this.layer._source.getTileId(this.x+t,this.y+e),s=i&&this.layer.tileMap.getTileDefinition(i);return s&&s.hasFullHitBox(this.layer.tileMap.tag)}static setRectangle(t,e,n,i,s){const o=t.vertices;o[0][0]=e,o[0][1]=n,o[1][0]=i,o[1][1]=n,o[2][0]=i,o[2][1]=s,o[3][0]=e,o[3][1]=s}};let M=x;M.workingTransformation=new p.AffineTransformation})(D=p.TileMap||(p.TileMap={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=TransformedTileMap.js.map
